{% extends 'base.html' %}
{% block head %}
<meta name="description" content="{{ blogBase['title'] }} search and tag page">
<title>{{ blogBase['title'] }} - ç½‘ç›˜æœç´¢</title>
{# <link href="{{ blogBase.homeUrl }}/pagefind/pagefind-ui.css" rel="stylesheet"> -- å·²ç§»é™¤æ—§çš„æœç´¢æ ·å¼ #}
{% endblock %}

{% block style %}
<style>
.tagTitle{margin:auto 0;font-size:40px;font-weight:bold;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}

/* --- [æ–°å¢] æ ‡ç­¾äº‘æ ·å¼ --- */
.tag-cloud-container {
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--borderColor-default, var(--color-border-default));
}
.tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* æ ‡ç­¾ä¹‹é—´çš„é—´è· */
    justify-content: center; /* æ ‡ç­¾æ•´ä½“å±…ä¸­ */
    padding: 1rem 0;
}
.tag-link {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px; /* èƒ¶å›Šå½¢çŠ¶ */
    color: white !important;
    text-decoration: none;
    font-size: 14px;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.tag-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* --- [æ–°å¢] ç›˜æœUIæ ·å¼ --- */
#pansou-container {
    padding: 20px;
    border: 1px solid var(--borderColor-default, var(--color-border-default));
    border-radius: 6px;
    margin-bottom: 2.5rem;
}
.search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
#pansou-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid var(--borderColor-default, var(--color-border-default));
    border-radius: 6px;
    font-size: 16px;
}
#pansou-button {
    padding: 10px 20px;
    border-radius: 6px;
    background-color: var(--color-btn-primary-bg, #2ea44f);
    color: var(--color-btn-primary-text, #ffffff);
    border: 1px solid var(--color-btn-primary-border, rgba(27,31,36,0.15));
    font-size: 16px;
    cursor: pointer;
}
#pansou-button:hover {
    background-color: var(--color-btn-primary-hover-bg, #2c974b);
}
#pansou-results {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
}
.results-summary {
    font-weight: bold;
    margin-bottom: 15px;
}
.result-category {
    margin-bottom: 20px;
}
.category-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    text-transform: capitalize; /* é¦–å­—æ¯å¤§å†™ */
    border-bottom: 2px solid var(--borderColor-default, var(--color-border-default));
    padding-bottom: 5px;
}
.result-item {
    list-style-type: none;
    margin-bottom: 15px;
    padding-left: 0;
}
.result-item a {
    font-weight: 600;
    color: var(--color-accent-fg, #0969da);
    text-decoration: none;
}
.result-item a:hover {
    text-decoration: underline;
}
.result-note {
    font-size: 14px;
    color: var(--color-fg-muted, #57606a);
    margin-top: 4px;
    word-break: break-all;
}
.result-password {
    font-weight: bold;
    color: var(--color-danger-fg, #cf222e);
    margin-left: 8px;
}
.result-source {
    font-size: 12px;
    color: #888;
    display: block;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div id="search">
    <div id="pansou-container">
        <div class="search-box">
            <input type="text" id="pansou-input" placeholder="è¾“å…¥å…³é”®è¯æœç´¢ç½‘ç›˜èµ„æº...">
            <button id="pansou-button">ç›˜æœä¸€ä¸‹</button>
        </div>
        <div id="pansou-results">
            </div>
    </div>
</div>

<div class="tag-cloud-container">
    <div class="tagTitle">æ ‡ç­¾äº‘</div>
    <div class="tag-cloud">
        {% for tag, count in blogBase.tagsJson.items() %}
            <a href="{{ blogBase.homeUrl }}/{{ tag }}.html" class="tag-link" style="background-color: hsl({{ 200 + loop.index * 20 }}, 70%, 50%); font-size: {{ 12 + (count|float / blogBase.maxTagsCount|float * 12)|round }}px;">
                {{ tag }} ({{ count }})
            </a>
        {% endfor %}
    </div>
</div>

<div class="mt-4">
    {% for num in range(blogBase.singeListJson|length) %}
        {% set tag = blogBase.singeListJson[num]['tag'] %}
        {% if tag %}
        <div class="mt-3">
            <a class="SideNav-à¤Ÿà¤°-item d-flex flex-items-center" href="{{ blogBase.homeUrl }}/{{ tag }}.html">
                <svg class="SideNav-icon octicon" style="width:16px;height:16px"><path class="svgTop{{ blogBase.singeListJson[num]['top'] }}" d=""></path></svg>
                <span class="text-bold flex-auto">{{ blogBase.singeListJson[num]['postTitle'] }}</span>
            </a>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endfor %}
{% endblock %}

{% block script %}
{# <script src="{{ blogBase.homeUrl }}/pagefind/pagefind-ui.js"></script> -- å·²ç§»é™¤æ—§çš„æœç´¢è„šæœ¬ #}
<script>
    // --- [æ–°å¢] PanSou æœç´¢åŠŸèƒ½è„šæœ¬ ---
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('pansou-input');
        const searchButton = document.getElementById('pansou-button');
        const resultsContainer = document.getElementById('pansou-results');
        const apiUrl = 'http://pansou.futuremedia.work/api/search';

        const performSearch = () => {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                alert('è¯·è¾“å…¥æœç´¢å…³é”®è¯ï¼');
                return;
            }

            resultsContainer.innerHTML = '<p>ğŸš€ æ­£åœ¨å…¨é€Ÿæœç´¢ä¸­ï¼Œè¯·ç¨å€™...</p>';

            // ä½¿ç”¨ GET æ–¹æ³•è¯·æ±‚ API
            fetch(`${apiUrl}?kw=${encodeURIComponent(keyword)}&res=merge`)
                .then(response => {
                    if (!response.ok) {
                        // å¦‚æœHTTPå“åº”çŠ¶æ€ç ä¸æ˜¯2xx, æŠ›å‡ºé”™è¯¯
                        return response.json().then(err => { throw new Error(err.message || 'ç½‘ç»œè¯·æ±‚å¤±è´¥') });
                    }
                    return response.json();
                })
                .then(data => {
                    renderResults(data);
                })
                .catch(error => {
                    console.error('æœç´¢å‡ºé”™:', error);
                    resultsContainer.innerHTML = `<p style="color: red;">âŒ æœç´¢å¤±è´¥ï¼š${error.message}</p>`;
                });
        };

        const renderResults = (data) => {
            if (!data || !data.merged_by_type || Object.keys(data.merged_by_type).length === 0) {
                resultsContainer.innerHTML = `<p class="results-summary">æœªæ‰¾åˆ°ä¸ "${searchInput.value}" ç›¸å…³çš„ç½‘ç›˜èµ„æºã€‚</p>`;
                return;
            }
            
            // è®¡ç®—æ€»é“¾æ¥æ•°
            let totalLinks = 0;
            for (const type in data.merged_by_type) {
                totalLinks += data.merged_by_type[type].length;
            }

            let html = `<p class="results-summary">ğŸ‰ å…±æ‰¾åˆ° ${totalLinks} ä¸ªç›¸å…³èµ„æºé“¾æ¥ï¼š</p>`;
            
            const categories = data.merged_by_type;
            
            for (const type in categories) {
                if (categories[type].length > 0) {
                    html += `<div class="result-category">`;
                    html += `<h3 class="category-title">${type}</h3>`;
                    html += `<ul>`;
                    
                    categories[type].forEach(item => {
                        html += `<li class="result-item">`;
                        html += `<a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.note || 'æ— æ ‡é¢˜'}</a>`;
                        
                        if (item.password) {
                            html += `<span class="result-password">å¯†ç : ${item.password}</span>`;
                        }
                        
                        html += `<p class="result-note">${item.url}</p>`;
                        html += `<span class="result-source">æ¥æº: ${item.source} | æ—¶é—´: ${new Date(item.datetime).toLocaleString()}</span>`;
                        html += `</li>`;
                    });
                    
                    html += `</ul>`;
                    html += `</div>`;
                }
            }
            
            resultsContainer.innerHTML = html;
        };

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                performSearch();
            }
        });
    });
</script>

<script>
// ä¿ç•™äº†å›¾æ ‡åŠ è½½çš„è„šæœ¬
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
iconTOP=document.getElementsByClassName("svgTop1");
iconPost=document.getElementsByClassName("svgTop0");
for(var i=0;i<iconTOP.length;i++){
    iconTOP[i].setAttribute("d",IconList["top"]);
}
for(var i=0;i<iconPost.length;i++){
    iconPost[i].setAttribute("d",IconList["post"]);
}
</script>
{% endblock %}
