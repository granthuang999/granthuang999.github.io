{% extends 'base.html' %}
{% block head %}
<meta name="description" content="{{ blogBase['title'] }} search and tag page">
<title>{{ blogBase['title'] }} - 网盘搜索</title>
{# <link href="{{ blogBase.homeUrl }}/pagefind/pagefind-ui.css" rel="stylesheet"> -- 已移除旧的搜索样式 #}
{% endblock %}

{% block style %}
<style>
.tagTitle{margin:auto 0;font-size:40px;font-weight:bold;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}

/* --- [新增] 标签云样式 --- */
.tag-cloud-container {
    margin-top: 2.5rem;
    padding-top: 1.5rem;
    border-top: 1px solid var(--borderColor-default, var(--color-border-default));
}
.tag-cloud {
    display: flex;
    flex-wrap: wrap;
    gap: 10px; /* 标签之间的间距 */
    justify-content: center; /* 标签整体居中 */
    padding: 1rem 0;
}
.tag-link {
    display: inline-block;
    padding: 8px 16px;
    border-radius: 20px; /* 胶囊形状 */
    color: white !important;
    text-decoration: none;
    font-size: 14px;
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}
.tag-link:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
}

/* --- [新增] 盘搜UI样式 --- */
#pansou-container {
    padding: 20px;
    border: 1px solid var(--borderColor-default, var(--color-border-default));
    border-radius: 6px;
    margin-bottom: 2.5rem;
}
.search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
#pansou-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid var(--borderColor-default, var(--color-border-default));
    border-radius: 6px;
    font-size: 16px;
}
#pansou-button {
    padding: 10px 20px;
    border-radius: 6px;
    background-color: var(--color-btn-primary-bg, #2ea44f);
    color: var(--color-btn-primary-text, #ffffff);
    border: 1px solid var(--color-btn-primary-border, rgba(27,31,36,0.15));
    font-size: 16px;
    cursor: pointer;
}
#pansou-button:hover {
    background-color: var(--color-btn-primary-hover-bg, #2c974b);
}
#pansou-results {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
}
.results-summary {
    font-weight: bold;
    margin-bottom: 15px;
}
.result-category {
    margin-bottom: 20px;
}
.category-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    text-transform: capitalize; /* 首字母大写 */
    border-bottom: 2px solid var(--borderColor-default, var(--color-border-default));
    padding-bottom: 5px;
}
.result-item {
    list-style-type: none;
    margin-bottom: 15px;
    padding-left: 0;
}
.result-item a {
    font-weight: 600;
    color: var(--color-accent-fg, #0969da);
    text-decoration: none;
}
.result-item a:hover {
    text-decoration: underline;
}
.result-note {
    font-size: 14px;
    color: var(--color-fg-muted, #57606a);
    margin-top: 4px;
    word-break: break-all;
}
.result-password {
    font-weight: bold;
    color: var(--color-danger-fg, #cf222e);
    margin-left: 8px;
}
.result-source {
    font-size: 12px;
    color: #888;
    display: block;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block content %}
<div id="search">
    <div id="pansou-container">
        <div class="search-box">
            <input type="text" id="pansou-input" placeholder="输入关键词搜索网盘资源...">
            <button id="pansou-button">盘搜一下</button>
        </div>
        <div id="pansou-results">
            </div>
    </div>
</div>

<div class="tag-cloud-container">
    <div class="tagTitle">标签云</div>
    <div class="tag-cloud">
        {% for tag, count in blogBase.tagsJson.items() %}
            <a href="{{ blogBase.homeUrl }}/{{ tag }}.html" class="tag-link" style="background-color: hsl({{ 200 + loop.index * 20 }}, 70%, 50%); font-size: {{ 12 + (count|float / blogBase.maxTagsCount|float * 12)|round }}px;">
                {{ tag }} ({{ count }})
            </a>
        {% endfor %}
    </div>
</div>

<div class="mt-4">
    {% for num in range(blogBase.singeListJson|length) %}
        {% set tag = blogBase.singeListJson[num]['tag'] %}
        {% if tag %}
        <div class="mt-3">
            <a class="SideNav-टर-item d-flex flex-items-center" href="{{ blogBase.homeUrl }}/{{ tag }}.html">
                <svg class="SideNav-icon octicon" style="width:16px;height:16px"><path class="svgTop{{ blogBase.singeListJson[num]['top'] }}" d=""></path></svg>
                <span class="text-bold flex-auto">{{ blogBase.singeListJson[num]['postTitle'] }}</span>
            </a>
        </div>
        {% endif %}
    {% endfor %}
</div>
{% endfor %}
{% endblock %}

{% block script %}
{# <script src="{{ blogBase.homeUrl }}/pagefind/pagefind-ui.js"></script> -- 已移除旧的搜索脚本 #}
<script>
    // --- [新增] PanSou 搜索功能脚本 ---
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('pansou-input');
        const searchButton = document.getElementById('pansou-button');
        const resultsContainer = document.getElementById('pansou-results');
        const apiUrl = 'http://pansou.futuremedia.work/api/search';

        const performSearch = () => {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                alert('请输入搜索关键词！');
                return;
            }

            resultsContainer.innerHTML = '<p>🚀 正在全速搜索中，请稍候...</p>';

            // 使用 GET 方法请求 API
            fetch(`${apiUrl}?kw=${encodeURIComponent(keyword)}&res=merge`)
                .then(response => {
                    if (!response.ok) {
                        // 如果HTTP响应状态码不是2xx, 抛出错误
                        return response.json().then(err => { throw new Error(err.message || '网络请求失败') });
                    }
                    return response.json();
                })
                .then(data => {
                    renderResults(data);
                })
                .catch(error => {
                    console.error('搜索出错:', error);
                    resultsContainer.innerHTML = `<p style="color: red;">❌ 搜索失败：${error.message}</p>`;
                });
        };

        const renderResults = (data) => {
            if (!data || !data.merged_by_type || Object.keys(data.merged_by_type).length === 0) {
                resultsContainer.innerHTML = `<p class="results-summary">未找到与 "${searchInput.value}" 相关的网盘资源。</p>`;
                return;
            }
            
            // 计算总链接数
            let totalLinks = 0;
            for (const type in data.merged_by_type) {
                totalLinks += data.merged_by_type[type].length;
            }

            let html = `<p class="results-summary">🎉 共找到 ${totalLinks} 个相关资源链接：</p>`;
            
            const categories = data.merged_by_type;
            
            for (const type in categories) {
                if (categories[type].length > 0) {
                    html += `<div class="result-category">`;
                    html += `<h3 class="category-title">${type}</h3>`;
                    html += `<ul>`;
                    
                    categories[type].forEach(item => {
                        html += `<li class="result-item">`;
                        html += `<a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.note || '无标题'}</a>`;
                        
                        if (item.password) {
                            html += `<span class="result-password">密码: ${item.password}</span>`;
                        }
                        
                        html += `<p class="result-note">${item.url}</p>`;
                        html += `<span class="result-source">来源: ${item.source} | 时间: ${new Date(item.datetime).toLocaleString()}</span>`;
                        html += `</li>`;
                    });
                    
                    html += `</ul>`;
                    html += `</div>`;
                }
            }
            
            resultsContainer.innerHTML = html;
        };

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                performSearch();
            }
        });
    });
</script>

<script>
// 保留了图标加载的脚本
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
iconTOP=document.getElementsByClassName("svgTop1");
iconPost=document.getElementsByClassName("svgTop0");
for(var i=0;i<iconTOP.length;i++){
    iconTOP[i].setAttribute("d",IconList["top"]);
}
for(var i=0;i<iconPost.length;i++){
    iconPost[i].setAttribute("d",IconList["post"]);
}
</script>
{% endblock %}
