{% extends 'base.html' %}

{% block head %}
<meta name="description" content="{{ blogBase['title'] }} 从网盘搜索各种资源">
<meta name="keywords" content="网盘，网盘搜索，百度网盘，阿里云盘，腾讯微云，天翼云盘，123云盘，迅雷云盘，蓝奏云，坚果云，和彩云‌，企业网盘‌，亿方云，Google Drive，Dropbox，OneDrive">
<title>{{ blogBase['title'] }} - 网盘搜索</title>
{% endblock %}

{% block style %}
<style>
/* --- 页面标题和右上角按钮样式 (参考tag.html) --- */
/* [关键修改] 从 .pageTitle 中删除了 font-size:40px; */
.pageTitle{margin:auto 0;font-weight:bold;overflow:hidden;white-space:nowrap;text-overflow:ellipsis;}
.title-right{display:flex;margin:auto 0 0 auto;}
.title-right .circle{padding: 14px 16px;margin-right:8px;}

/* --- 盘搜UI样式 --- */
#pansou-container {
    padding: 20px;
    border: 1px solid var(--borderColor-default, var(--color-border-default));
    border-radius: 6px;
    margin-bottom: 2.5rem;
}
.search-box {
    display: flex;
    gap: 10px;
    margin-bottom: 20px;
}
#pansou-input {
    flex-grow: 1;
    padding: 10px;
    border: 1px solid var(--borderColor-default, var(--color-border-default));
    border-radius: 6px;
    font-size: 16px;
    background-color: var(--bgColor-default, var(--color-canvas-default));
    color: var(--fgColor-default, var(--color-fg-default));
}
#pansou-button {
    padding: 10px 20px;
    border-radius: 6px;
    background-color: var(--color-btn-primary-bg, #2ea44f);
    color: var(--color-btn-primary-text, #ffffff);
    border: 1px solid var(--color-btn-primary-border, rgba(27,31,36,0.15));
    font-size: 16px;
    cursor: pointer;
}
#pansou-button:hover {
    background-color: var(--color-btn-primary-hover-bg, #2c974b);
}
#pansou-results {
    font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Helvetica,Arial,sans-serif,"Apple Color Emoji","Segoe UI Emoji";
}
.results-summary {
    font-weight: bold;
    margin-bottom: 15px;
}
.result-category {
    margin-bottom: 20px;
}
.category-title {
    font-size: 20px;
    font-weight: bold;
    margin-bottom: 10px;
    text-transform: capitalize; /* 首字母大写 */
    border-bottom: 2px solid var(--borderColor-default, var(--color-border-default));
    padding-bottom: 5px;
}
.result-item {
    list-style-type: none;
    margin-bottom: 15px;
    padding-left: 0;
}
.result-item a {
    font-weight: 600;
    color: var(--color-accent-fg, #0969da);
    text-decoration: none;
}
.result-item a:hover {
    text-decoration: underline;
}
.result-note {
    font-size: 14px;
    color: var(--color-fg-muted, #57606a);
    margin-top: 4px;
    word-break: break-all;
}
.result-password {
    font-weight: bold;
    color: var(--color-danger-fg, #cf222e);
    margin-left: 8px;
}
.result-source {
    font-size: 12px;
    color: #888;
    display: block;
    margin-top: 5px;
}
</style>
{% endblock %}

{% block header %}
<h1 class="pageTitle">网盘资源搜索-未来传媒-关注中年人</h1>
<div class="title-right">
    <a href="{{ blogBase['homeUrl'] }}" id="buttonHome" class="btn btn-invisible circle" title="{{ i18n['home'] }}">
        <svg class="octicon" width="16" height="16">
            <path id="pathHome" fill-rule="evenodd"></path>
        </svg>
    </a>
    <a class="btn btn-invisible circle" onclick="modeSwitch()" title="{{ i18n['switchTheme'] }}" {%- if blogBase['themeMode']=='fix' -%}style="display:none;"{%- endif -%}>
        <svg class="octicon" width="16" height="16" >
            <path id="themeSwitch" fill-rule="evenodd"></path>
        </svg>
    </a>
</div>
{% endblock %}

{% block content %}
<div id="search">
    <div id="pansou-container">
        <div class="search-box">
            <input type="text" id="pansou-input" placeholder="输入关键词搜索网盘资源...">
            <button id="pansou-button">盘搜一下</button>
        </div>
        <div id="pansou-results">
            </div>
    </div>
</div>
{% endblock %}

{% block script %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const searchInput = document.getElementById('pansou-input');
        const searchButton = document.getElementById('pansou-button');
        const resultsContainer = document.getElementById('pansou-results');
        const apiUrl = 'https://www.futuremedia.work/api-proxy/'; // 使用Cloudflare代理地址

        const performSearch = () => {
            const keyword = searchInput.value.trim();
            if (!keyword) {
                alert('请输入搜索关键词！');
                return;
            }

            resultsContainer.innerHTML = '<p>🚀 正在全速搜索中，请稍候...</p>';

            fetch(`${apiUrl}?kw=${encodeURIComponent(keyword)}`)
                .then(response => {
                    if (!response.ok) {
                        return response.json().then(err => { throw new Error(err.message || '网络请求失败') });
                    }
                    return response.json();
                })
                .then(data => {
                    renderResults(data);
                })
                .catch(error => {
                    console.error('搜索出错:', error);
                    resultsContainer.innerHTML = `<p style="color: red;">❌ 搜索失败：${error.message}</p>`;
                });
        };

        const renderResults = (data) => {
            // [修正] 从 data.data 中读取 merged_by_type
            if (!data || !data.data || !data.data.merged_by_type || Object.keys(data.data.merged_by_type).length === 0) {
                resultsContainer.innerHTML = `<p class="results-summary">未找到与 "${searchInput.value}" 相关的网盘资源。</p>`;
                return;
            }
            
            // [修正] 从 data.data 中计算总链接数
            let totalLinks = 0;
            for (const type in data.data.merged_by_type) {
                totalLinks += data.data.merged_by_type[type].length;
            }

            let html = `<p class="results-summary">🎉 共找到 ${totalLinks} 个相关资源链接：</p>`;
            
            // [修正] 从 data.data 中获取结果分类
            const categories = data.data.merged_by_type;
            
            for (const type in categories) {
                if (categories[type].length > 0) {
                    html += `<div class="result-category">`;
                    html += `<h3 class="category-title">${type}</h3>`;
                    html += `<ul>`;
                    
                    categories[type].forEach(item => {
                        html += `<li class="result-item">`;
                        html += `<a href="${item.url}" target="_blank" rel="noopener noreferrer">${item.note || '无标题'}</a>`;
                        
                        if (item.password) {
                            html += `<span class="result-password">密码: ${item.password}</span>`;
                        }
                        
                        html += `<p class="result-note">${item.url}</p>`;
                        html += `<span class="result-source">来源: ${item.source} | 时间: ${new Date(item.datetime).toLocaleString()}</span>`;
                        html += `</li>`;
                    });
                    
                    html += `</ul>`;
                    html += `</div>`;
                }
            }
            
            resultsContainer.innerHTML = html;
        };

        searchButton.addEventListener('click', performSearch);
        searchInput.addEventListener('keyup', (event) => {
            if (event.key === 'Enter') {
                performSearch();
            }
        });
    });
</script>

<script>
// 图标加载脚本 (参考tag.html)
document.getElementById("pathHome").setAttribute("d",IconList["home"]);
</script>
{% endblock %}
