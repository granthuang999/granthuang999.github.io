# GitHub Action: Sync new articles from GitHub Issues to WeChat Official Account (Final & Self-Contained Version)

name: Sync to WeChat Official Account

# è§¦å‘æ¡ä»¶ï¼šå½“ä¸€ä¸ª Issue è¢«æ‰“ä¸Š "Publish" æ ‡ç­¾æ—¶è§¦å‘
on:
  issues:
    types: [labeled]

jobs:
  sync:
    # åªæœ‰å½“è¢«æ‰“ä¸Šçš„æ ‡ç­¾æ˜¯ "Publish" æ—¶ï¼Œæ‰æ‰§è¡Œä»»åŠ¡
    if: github.event.label.name == 'Publish'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        # ä½¿ç”¨å®˜æ–¹ç¨³å®šçš„ action æ¥æ£€å‡ºä»£ç 
        uses: actions/checkout@v3

      - name: Set up Python
        # ä½¿ç”¨å®˜æ–¹ç¨³å®šçš„ action æ¥è®¾ç½® Python ç¯å¢ƒ
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        # å®‰è£…è„šæœ¬éœ€è¦çš„åº“
        run: |
          python -m pip install --upgrade pip
          pip install requests beautifulsoup4 markdown2

      - name: Run Sync Script
        # è¿è¡Œæˆ‘ä»¬è‡ªå·±ç¼–å†™çš„ Python è„šæœ¬
        run: |
          import os
          import requests
          import json
          import markdown2
          from bs4 import BeautifulSoup

          # --- 1. ä» GitHub Secrets è·å–å®‰å…¨ä¿¡æ¯ ---
          app_id = os.environ.get('APP_ID')
          app_secret = os.environ.get('APP_SECRET')
          issue_title = os.environ.get('ISSUE_TITLE')
          issue_body_md = os.environ.get('ISSUE_BODY')
          github_token = os.environ.get('GITHUB_TOKEN')
          repo_owner = os.environ.get('REPO_OWNER')
          repo_name = os.environ.get('REPO_NAME')

          if not all([app_id, app_secret, issue_title, issue_body_md, github_token, repo_owner, repo_name]):
              print("::error::Missing required environment variables.")
              exit(1)

          # --- 2. è·å– Access Token ---
          token_url = f"https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid={app_id}&secret={app_secret}"
          try:
              token_res = requests.get(token_url).json()
              if 'access_token' not in token_res:
                  print(f"::error::Failed to get access_token: {token_res}")
                  exit(1)
              access_token = token_res['access_token']
              print("Successfully got access_token.")
          except Exception as e:
              print(f"::error::Exception when getting access_token: {e}")
              exit(1)

          # --- 3. å¤„ç† Markdown å’Œå›¾ç‰‡ ---
          html_body = markdown2.markdown(issue_body_md, extras=["fenced-code-blocks", "tables"])
          soup = BeautifulSoup(html_body, 'html.parser')
          
          # æŸ¥æ‰¾æ‰€æœ‰å›¾ç‰‡å¹¶ä¸Šä¼ åˆ°å¾®ä¿¡æœåŠ¡å™¨
          for img in soup.find_all('img'):
              img_url = img['src']
              try:
                  # ä¸‹è½½å›¾ç‰‡å†…å®¹
                  img_response = requests.get(img_url)
                  img_response.raise_for_status()
                  img_content = img_response.content
                  
                  # ä¸Šä¼ å›¾ç‰‡åˆ°å¾®ä¿¡
                  upload_url = f"https://api.weixin.qq.com/cgi-bin/media/uploadimg?access_token={access_token}"
                  files = {'media': ('image.jpg', img_content)}
                  upload_res = requests.post(upload_url, files=files).json()
                  
                  if 'url' in upload_res:
                      wx_img_url = upload_res['url']
                      img['src'] = wx_img_url # æ›¿æ¢ä¸ºå¾®ä¿¡å›¾ç‰‡é“¾æ¥
                      print(f"Successfully uploaded and replaced image: {img_url} -> {wx_img_url}")
                  else:
                      print(f"::warning::Failed to upload image {img_url}: {upload_res}")
              except Exception as e:
                  print(f"::warning::Exception when processing image {img_url}: {e}")

          final_html_content = str(soup)

          # --- 4. æ„é€ å¹¶ä¸Šä¼ å›¾æ–‡ç´ æ ---
          article = {
              "title": issue_title,
              "author": "æœªæ¥ä¼ åª’",  # æ‚¨å¯ä»¥ä¿®æ”¹ä¸ºæ‚¨çš„ç¬”å
              "digest": "", # æ‘˜è¦ä¼šè‡ªåŠ¨æˆªå–æ­£æ–‡å‰54ä¸ªå­—
              "content": final_html_content,
              "content_source_url": "", # å¯ä»¥ç•™ç©ºæˆ–å¡«å†™åŸæ–‡é“¾æ¥
              "thumb_media_id": "", # å¿…é¡»æä¾›ä¸€ä¸ªå°é¢å›¾ç‰‡ ID
              "show_cover_pic": 0 # 0ä¸æ˜¾ç¤ºï¼Œ1æ˜¾ç¤ºå°é¢
          }
          
          print("::error::å°é¢å›¾ç‰‡åŠŸèƒ½(thumb_media_id)éœ€è¦æ‚¨å…ˆåœ¨ç´ æåº“ä¸Šä¼ ä¸€å¼ é»˜è®¤å°é¢å›¾å¹¶è·å–å…¶media_id, ç„¶åå¡«å…¥è„šæœ¬ã€‚è¿™æ˜¯ä¸€ä¸ªå¿…è¦æ­¥éª¤ã€‚")
          print("::warning::ç”±äºç¼ºå°‘å°é¢å›¾ç‰‡ID (thumb_media_id), æœ¬æ¬¡åŒæ­¥å°†ä¼šå¤±è´¥ã€‚è¯·æŒ‰æ–‡æ¡£è¯´æ˜é…ç½®ã€‚")
          #  exit(1) # æš‚æ—¶æ³¨é‡Šæ‰ï¼Œè®©æ‚¨å…ˆçœ‹åˆ°æµç¨‹ï¼Œä½†è¯·åŠ¡å¿…é…ç½®å°é¢

          upload_article_url = f"https://api.weixin.qq.com/cgi-bin/draft/add?access_token={access_token}"
          headers = {'Content-Type': 'application/json'}
          payload = {"articles": [article]}
          
          try:
              upload_article_res = requests.post(upload_article_url, headers=headers, data=json.dumps(payload, ensure_ascii=False).encode('utf-8')).json()
              if 'media_id' in upload_article_res:
                  print(f"ğŸ‰ Successfully synced article '{issue_title}' to WeChat Drafts!")
              else:
                  print(f"::error::Failed to upload article: {upload_article_res}")
                  exit(1)
          except Exception as e:
              print(f"::error::Exception when uploading article: {e}")
              exit(1)

        env:
          APP_ID: ${{ secrets.WECHAT_APPID }}
          APP_SECRET: ${{ secrets.WECHAT_APPSECRET }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO_OWNER: ${{ github.repository_owner }}
          REPO_NAME: ${{ github.event.repository.name }}
