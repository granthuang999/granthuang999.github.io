name: Sync to WeChat Official Account

on:
  issues:
    types: [labeled]

jobs:
  sync:
    if: github.event.label.name == 'Publish'
    runs-on: ubuntu-latest
    steps:
      - name: Trigger Sync Service
        # æ ¸å¿ƒä¿®æ­£ï¼šä¸å†ä½¿ç”¨Here Documentå’Œjqï¼Œç›´æ¥åœ¨envä¸­ç”¨toJSON()å‡½æ•°å¤„ç†æ•°æ®
        # è¿™æ˜¯å¤„ç†åŒ…å«ç‰¹æ®Šå­—ç¬¦çš„å­—ç¬¦ä¸²çš„æœ€ç¨³å¥æ–¹æ³•
        run: |
          response=$(curl -s -w "\n%{http_code}" -X POST \
            -H "Authorization: Bearer ${{ secrets.SECRET_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "app_id": "${{ secrets.WECHAT_APPID }}",
              "app_secret": "${{ secrets.WECHAT_APPSECRET }}",
              "thumb_media_id": "${{ secrets.WECHAT_THUMB_MEDIA_ID }}",
              "issue_title": ${{ env.JSON_ESCAPED_ISSUE_TITLE }},
              "issue_body": ${{ env.JSON_ESCAPED_ISSUE_BODY }}
            }' \
            "https://wechat-sync-service.onrender.com/sync")
          
          http_code=$(tail -n1 <<< "$response")
          body=$(head -n-1 <<< "$response")
          
          if [ "$http_code" -ne 200 ]; then
            echo "::error::Failed to trigger sync service. Status: $http_code, Response: $body"
            exit 1
          else
            echo "ğŸ‰ Successfully triggered sync service! Response: $body"
          fi
        env:
          # ä½¿ç”¨ toJSON() å‡½æ•°å°†æ ‡é¢˜å’Œæ­£æ–‡é¢„å…ˆå¤„ç†æˆå®‰å…¨çš„JSONå­—ç¬¦ä¸²
          JSON_ESCAPED_ISSUE_TITLE: ${{ toJSON(github.event.issue.title) }}
          JSON_ESCAPED_ISSUE_BODY: ${{ toJSON(github.event.issue.body) }}
