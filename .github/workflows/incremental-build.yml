name: Incremental Build (Issues & Related Pushes)

on:
  issues:
    types: [opened, edited]
  push:
    branches: [main]

jobs:
  build-incremental:
    name: Incremental Build and Deploy
    runs-on: ubuntu-latest
    if: |
      github.repository == 'granthuang999/granthuang999.github.io' &&
      (github.event_name == 'issues' || (github.event_name == 'push' && contains(github.event.head_commit.message, '#')))
    permissions:
      contents: write
      pages: write
      id-token: write
    steps:
      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine Issue Number
        id: determine_issue
        env:
          COMMIT_MSG: "${{ github.event.head_commit.message }}"
        run: |
          ISSUE_NUMBER=""
          if [ "${{ github.event_name }}" == "issues" ]; then
            ISSUE_NUMBER="${{ github.event.issue.number }}"
            echo "Triggered by issue event. Building for #${ISSUE_NUMBER}"
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "Triggered by push event. Commit message: $COMMIT_MSG"
            issue_from_commit=$(echo "$COMMIT_MSG" | grep -o '#[0-9]\+' | sed 's/#//')
            ISSUE_NUMBER="$issue_from_commit"
            echo "Found issue number in commit message. Building for #${ISSUE_NUMBER}"
          fi
          echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT

      # [ä¿®æ­£] ç§»é™¤äº†ä¹‹å‰å¯¼è‡´é”™è¯¯çš„ 'Run Incremental Build Steps' æ­¥éª¤
      # åç»­æ­¥éª¤çš„ 'if' æ¡ä»¶ä¼šç¡®ä¿åªæœ‰åœ¨éœ€è¦æ—¶æ‰è¿è¡Œ

      - name: Set up Python
        if: steps.determine_issue.outputs.issue_number != ''
        uses: actions/setup-python@v5
        with:
          python-version: '3.9'

      - name: Clone Gmeek Theme & Install dependencies
        if: steps.determine_issue.outputs.issue_number != ''
        run: |
          git clone https://github.com/granthuang999/Gmeek.git /opt/Gmeek
          pip install --upgrade pip
          pip install -r /opt/Gmeek/requirements.txt

      - name: Generate HTML for single issue
        if: steps.determine_issue.outputs.issue_number != ''
        run: |
          rm -f /opt/Gmeek/static
          
          cp -r ./* /opt/Gmeek/
          cd /opt/Gmeek/
          python Gmeek.py ${{ secrets.GITHUB_TOKEN }} ${{ github.repository }} --issue_number '${{ steps.determine_issue.outputs.issue_number }}'
          cp -a /opt/GGmeek/docs/. ${{ github.workspace }}/docs/
          cp -a /opt/Gmeek/backup/. ${{ github.workspace }}/backup/
          cp /opt/Gmeek/blogBase.json ${{ github.workspace }}/

      - name: Checkout external repos
        if: steps.determine_issue.outputs.issue_number != ''
        run: |
          git clone https://github.com/granthuang999/English-level-up-tips.git ${{ github.workspace }}/docs/english-study
          git clone https://github.com/granthuang999/english-ebooks.git ${{ github.workspace }}/docs/english-book
          rm -rf ${{ github.workspace }}/docs/english-study/.git
          rm -rf ${{ github.workspace }}/docs/english-book/.git

      - name: Setup Node.js & Index with Pagefind
        if: steps.determine_issue.outputs.issue_number != ''
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - run: |
          npm config set registry https://registry.npmmirror.com/
          npx -y pagefind --site docs
        if: steps.determine_issue.outputs.issue_number != ''

      - name: Commit and Push build files
        if: steps.determine_issue.outputs.issue_number != ''
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add docs/ backup/ blogBase.json
          if ! git diff --quiet --cached; then
            git commit -m "ğŸš€ chore(incremental): auto build for issue #${{ steps.determine_issue.outputs.issue_number }}"
            git push
          else
            echo "No changes to site content to commit."
          fi

      - name: Upload artifact for deployment
        if: steps.determine_issue.outputs.issue_number != ''
        uses: actions/upload-pages-artifact@v3
        with:
          path: 'docs/'

      - name: Deploy to GitHub Pages
        if: steps.determine_issue.outputs.issue_number != ''
        id: deployment
        uses: actions/deploy-pages@v4
